#!/bin/zsh
local main_program=$1
shift
local pids=()

# Pre-authenticate sudo if needed
for bg_program in "$@"; do
    if [[ "$bg_program" =~ "sudo" ]]; then
        echo "Authenticating sudo for background processes..."
        sudo -v
        break
    fi
done

# Also check main program
if [[ "$main_program" =~ "sudo" ]]; then
    sudo -v
fi

for bg_program in "$@"; do
    eval "$bg_program" &
    pids+=$!
done

trap "kill $pids 2>/dev/null; return 130" INT
trap "kill $pids 2>/dev/null" EXIT

eval "$main_program"
local exit_code=$?

kill $pids 2>/dev/null

return $exit_code
